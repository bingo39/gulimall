商城业务-商品详情
==

## 环境搭建

+ 搭建域名：【在host文件中模拟搭建域名】
    + item.gulimall.com
+ nginx 配置文件配置域名跳转
    + `cd /mydata/nginx/conf/conf.d/gulimall.config`【个人路径】
    + server模块添加`item.gulimall.com`或`*.gulimall.com`
+ 网关服务配置域名

```yaml
spring:cloud:getway:routes:
  ## *.gulimall.com请求转给search服务
  - id: gulimall_search_route
    uri: lb://gulimall-search
    predicates:
      - Host=search.gulimall.com,item.gulimall.com
```

+ 把静态资源发送到nginx中的/html/item
+ 在系统中创建item.html

## 需求介绍

1. sku的基本信息【表：pms_sku_info】
2. sku的图片信息【表：pms_sku_images】
3. 获取spu的销售属性组合【表：】

<img src="C:/Users/bingo39/AppData/Roaming/Typora/typora-user-images/image-20230810122830122.png" alt="image-20230810122830122" style="zoom:67%;" />

4. 商品介绍 【spu信息共享，只是销售属性不一样】

5. sku的“规格与包装”参数信息

## 业务代码

### 获取spu的销售属性组合

+ 获取当前spu有多少对应的属性分组

  ```sql
  SELECT
  	pav.`spu_id`,
  	ag.`attr_group_name`,
  	ag.`attr_group_id`,
  	aar.`attr_id`,
  	attr.`attr_name`,
  	pav.`attr_value` 
  FROM
  	`pms_attr_group` ag
  	LEFT JOIN `pms_attr_attrgroup_relation` aar ON aar.`attr_group_id` = ag.`attr_group_id`
  	LEFT JOIN `pms_attr` attr ON attr.`attr_id` = aar.`attr_id`
  	LEFT JOIN `pms_product_attr_value` pav ON pav.`attr_id` = attr.`attr_id` 
  WHERE
  	ag.catelog_id = 225 
  	AND pav.`spu_id` = 13;
  ```

+ sku销售属性组合

<font color=red>业务需求:</font>

在获取了spu集合信息后，还需要对spu组合进行划分，即根据上图，sku组合可根据"颜色"，“版本”，“内存”之间进行不同的**动态切换**销售组合。

**<font color=green>业务sql:</font>**

》商品汇总：

```sql
SELECT 
ssav.attr_id attr_id,ssav.attr_name attr_name,
## 汇总函数GROUP_CONCAT，去重DISTINCT
GROUP_CONCAT(DISTINCT ssav.attr_value) attr_value
 FROM `pms_sku_info` info 
LEFT JOIN `pms_sku_sale_attr_value` ssav ON ssav.sku_id = info.sku_id
WHERE info.spu_id = #{spuId}
GROUP BY ssav.attr_id,ssav.attr_name;
```

》动态切换商品：

-- sku组合可根据"颜色"，“版本”，“内存”之间进行不同的**动态切换**销售组合

```sql
SELECT 
ssav.attr_id attr_id,
ssav.attr_name attr_name,
ssav.attr_value,
GROUP_CONCAT(DISTINCT info.sku_id) sku_ids
 FROM `pms_sku_info` info 
LEFT JOIN `pms_sku_sale_attr_value` ssav ON ssav.sku_id = info.sku_id
WHERE info.spu_id = #{spuId}
GROUP BY ssav.attr_id,ssav.attr_name,ssav.attr_value;
```



