商城检索功能
==

## 搭建页面环境

### 页面搭建

> 规定
> 所有静态资源都放在nginx里面
> `/static/`所有请求都由nginx直接返回

+ 引入thymeleaf依赖

  ```xml
          <!--引入thymeleaf-->
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-thymeleaf</artifactId>
          </dependency>
  ```

+ 把静态资源放入到nginx下 nginx挂载路径+search目录:`mydata\ngnix\search`

  修改nginx配置文件gulimall.conf  `server_name *.gulimall.com，gulimall.com;`指所有后缀名为gulimall.com的访问都能代理重定向

+ 修改getway网关转发

  ```xml
  ## search.gulimall.com请求转给search服务
          - id: gulimall_search_route
            uri: lb://gulimall-search
            predicates:
              - Host=search.gulimall.com
  ```

## 检索服务

+ 商城检索-检索条件分析
    + 全文检索：skuTitle
    + 排序：saleCount【销量】、hotScore【热度】、skuPrice【价格】
    + 过滤：hasStock【是否有货】、skuPrice区间、brandId、catalog3Id、attrs
    + 聚合：attrs

> 所有检索条件参考：
>
> keyword=小米 &sort=saleCount_desc/asc&hasStock=0/1&skuPrice=400_1900&brandId=1&catalog3Id=1&at trs=1_3G:4G:5G&attrs=2_骁龙845&attrs=4_高清屏

### ES做检索

【根据上述分析的检索条件，做ES查询】

> ES查询使用的语句叫做DSL

完整查询语句

```json
# 模糊匹配；过滤（按照属性，分类，品牌，价格区间，库存）；排序；分类；高亮
GET product/_search
{
  //查询
  "query": {
    "bool": {
      //必须检索条件
      "must": [
        {
          "match":{
            "skuTitle":"小米"
          }
        }
      ],
      //过滤
      "filter":[
        //按照属性进行过滤
        {
          "nested":{
            "path":"attrs",
            "query":{
              "bool":{
                "must":[
                  {
                    "term":{
                      "attrs.attrId":{
                        "value":"15"
                      }
                    }
                  },
                  {
                    "terms":{
                      "attrs.attrValue":[
                         "海思（Hisilicon）"
                      ]
                    }
                  }
                ]
              }
            }
          }
        },
        //按照库存
        {
          "term":{
            "hasStock":"false"
          }
        },
        //按照价格区间
        {
          "range":{
            "skuPrice":{
              "gte":0,    //大于或等于0
              "lte":6000    //小于或等于6000
            }
          }
        }
      ]
    }
  },
  // 排序
  "sort":[
    {
      "skuPrice": {       //指定排序规则
        "order": "desc"
      }
    }
  ],
  // 分页
  "from":0,
  "size":5,
  // 高亮【前置、后置标签】
  "highlight": {
    "fields": {"skuTitle": {}}, //高亮对象
    "pre_tags": "<b style='color:red'>",
    "post_tags": "</b>"
  }
}
```

其中：`must`存放的是检索条件，`filter`存放的是过滤条件 【参考下图】

+ <font color=red>备注：</font> 嵌套查询的要求： 当初设计商品规格参数（详见gulimall-common服务的SkuEsModel类的attrs属性），是使用嵌套式的，且`put`
  数据进ES也是使用`type:nested`，ES默认会对数据进行扁平化处理。所以查询的时候，也得指明为`nested`，常规查询方式无法查询到`nested`类型的数据